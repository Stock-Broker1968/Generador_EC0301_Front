<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Plataforma EC0301 - Acceso</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Puedes usar tu propio CSS, aqu√≠ uso Bootstrap + estilos ligeros -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top left, #7b5cff 0, #2b1e94 45%, #140b3b 100%);
      min-height: 100vh;
      color: #111827;
    }

    .shell {
      max-width: 1180px;
      margin: 32px auto;
      background: #f9fafb;
      border-radius: 24px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
      padding: 24px 28px 32px;
    }

    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }

    .app-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .app-logo {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 20%, #fbbf24, #f97316);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 22px;
      box-shadow: 0 10px 30px rgba(249, 115, 22, 0.5);
    }

    .app-subtitle {
      font-size: 13px;
      color: #6b7280;
    }

    .status-pill {
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
    }

    .status-active {
      background: #ecfdf3;
      color: #15803d;
      border: 1px solid #bbf7d0;
    }

    .status-loading {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .btn-logout {
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      padding-inline: 18px;
    }

    .welcome {
      margin-bottom: 8px;
    }

    .welcome h1 {
      font-size: clamp(1.5rem, 1.2rem + 1vw, 1.9rem);
      margin-bottom: 4px;
    }

    .welcome p {
      font-size: 0.95rem;
      color: #4b5563;
      margin: 0;
    }

    .hint-text {
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 18px;
    }

    .modules-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
      margin-top: 10px;
    }

    .module-card {
      background: #ffffff;
      border-radius: 18px;
      padding: 16px 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 12px 25px rgba(15, 23, 42, 0.06);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 170px;
    }

    .module-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 6px;
    }

    .module-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .step-pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      font-weight: 600;
      white-space: nowrap;
    }

    .module-body {
      font-size: 0.85rem;
      color: #4b5563;
      margin-bottom: 10px;
    }

    .module-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .progress-text {
      font-weight: 600;
      color: #111827;
    }

    .progress-sub {
      color: #6b7280;
      font-size: 0.78rem;
    }

    .badge-state {
      font-size: 0.72rem;
      border-radius: 999px;
      padding: 3px 7px;
    }

    .badge-en-progreso {
      background: #eff6ff;
      color: #1d4ed8;
    }

    .badge-completo {
      background: #ecfdf3;
      color: #15803d;
    }

    .badge-bloqueado {
      background: #fef2f2;
      color: #b91c1c;
    }

    .btn-open {
      border-radius: 999px;
      font-size: 0.83rem;
      padding: 6px 14px;
    }

    .btn-open[disabled] {
      cursor: not-allowed;
      opacity: 0.5;
    }

    /* Modal de error cr√≠tico */
    .critical-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .critical-modal {
      background: #ffffff;
      border-radius: 18px;
      max-width: 440px;
      width: 90%;
      padding: 24px 22px 18px;
      text-align: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.35);
    }

    .critical-icon {
      width: 70px;
      height: 70px;
      border-radius: 999px;
      border: 2px solid #fecaca;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      color: #dc2626;
      font-size: 32px;
    }

    .critical-title {
      font-size: 1.15rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .critical-body {
      font-size: 0.9rem;
      color: #4b5563;
      margin-bottom: 18px;
    }
  </style>
</head>
<body>

  <div class="shell">
    <header class="app-header">
      <div class="app-title">
        <div class="app-logo">
          üéì
        </div>
        <div>
          <div class="fw-semibold">Plataforma EC0301</div>
          <div class="app-subtitle">Generador profesional de documentos</div>
        </div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <span id="badge-estado" class="status-pill status-loading">
          Cargando acceso...
        </span>
        <button id="btnLogout" class="btn btn-outline-danger btn-logout">
          Cerrar sesi√≥n
        </button>
      </div>
    </header>

    <section class="welcome">
      <h1>Bienvenido a tu Plataforma</h1>
      <p>
        Completa cada m√≥dulo en orden para generar tu portafolio alineado al est√°ndar EC0301.
      </p>
    </section>

    <p class="hint-text">
      Los m√≥dulos se ir√°n <strong>desbloqueando autom√°ticamente</strong> conforme avances:
      primero <strong>Carta Descriptiva</strong>, luego <strong>Log√≠stica</strong>, <strong>Evaluaciones</strong>, <strong>Manuales</strong>, <strong>Respuestas</strong> y finalmente <strong>Auditor√≠a</strong>.
    </p>

    <div class="modules-grid">

      <!-- 1. Carta Descriptiva -->
      <article class="module-card" data-module="carta">
        <div>
          <div class="module-header-row">
            <div class="module-title">Carta Descriptiva</div>
            <div class="step-pill">Paso 1 de 6</div>
          </div>
          <p class="module-body">
            Genera el guion instruccional completo de tu curso de capacitaci√≥n.
          </p>
        </div>
        <div class="module-footer">
          <div>
            <div class="progress-text">
              Avance: <span id="avance-carta">0%</span>
            </div>
            <div class="progress-sub">
              <span id="estado-texto-carta" class="badge-state badge-en-progreso">
                En progreso
              </span>
            </div>
          </div>
          <button
            class="btn btn-primary btn-open"
            data-target="carta_descriptiva.html"
            id="btn-carta"
          >
            Abrir m√≥dulo ‚Üí
          </button>
        </div>
      </article>

      <!-- 2. Log√≠stica y Formatos -->
      <article class="module-card" data-module="logistica">
        <div>
          <div class="module-header-row">
            <div class="module-title">Log√≠stica y Formatos</div>
            <div class="step-pill">Paso 2 de 6</div>
          </div>
          <p class="module-body">
            Genera listas de asistencia, contratos y formatos de requerimientos.
          </p>
        </div>
        <div class="module-footer">
          <div>
            <div class="progress-text">
              Avance: <span id="avance-logistica">0%</span>
            </div>
            <div class="progress-sub">
              <span id="estado-texto-logistica" class="badge-state badge-bloqueado">
                Bloqueado
              </span>
            </div>
          </div>
          <button
            class="btn btn-primary btn-open"
            data-target="logistica.html"
            id="btn-logistica"
            disabled
          >
            Abrir m√≥dulo ‚Üí
          </button>
        </div>
      </article>

      <!-- 3. Evaluaciones -->
      <article class="module-card" data-module="evaluaciones">
        <div>
          <div class="module-header-row">
            <div class="module-title">Instrumentos de Evaluaci√≥n</div>
            <div class="step-pill">Paso 3 de 6</div>
          </div>
          <p class="module-body">
            Crea r√∫bricas, listas de cotejo y gu√≠as de observaci√≥n alineadas al est√°ndar.
          </p>
        </div>
        <div class="module-footer">
          <div>
            <div class="progress-text">
              Avance: <span id="avance-evaluaciones">0%</span>
            </div>
            <div class="progress-sub">
              <span id="estado-texto-evaluaciones" class="badge-state badge-bloqueado">
                Bloqueado
              </span>
            </div>
          </div>
          <button
            class="btn btn-primary btn-open"
            data-target="evaluaciones.html"
            id="btn-evaluaciones"
            disabled
          >
            Abrir m√≥dulo ‚Üí
          </button>
        </div>
      </article>

      <!-- 4. Manuales -->
      <article class="module-card" data-module="manuales">
        <div>
          <div class="module-header-row">
            <div class="module-title">Manuales del Curso</div>
            <div class="step-pill">Paso 4 de 6</div>
          </div>
          <p class="module-body">
            Desarrolla los manuales del participante y del facilitador.
          </p>
        </div>
        <div class="module-footer">
          <div>
            <div class="progress-text">
              Avance: <span id="avance-manuales">0%</span>
            </div>
            <div class="progress-sub">
              <span id="estado-texto-manuales" class="badge-state badge-bloqueado">
                Bloqueado
              </span>
            </div>
          </div>
          <button
            class="btn btn-primary btn-open"
            data-target="manuales.html"
            id="btn-manuales"
            disabled
          >
            Abrir m√≥dulo ‚Üí
          </button>
        </div>
      </article>

      <!-- 5. Hoja de Respuestas -->
      <article class="module-card" data-module="respuestas">
        <div>
          <div class="module-header-row">
            <div class="module-title">Hoja de Respuestas</div>
            <div class="step-pill">Paso 5 de 6</div>
          </div>
          <p class="module-body">
            Crea la clave de respuestas para tus instrumentos de evaluaci√≥n.
          </p>
        </div>
        <div class="module-footer">
          <div>
            <div class="progress-text">
              Avance: <span id="avance-respuestas">0%</span>
            </div>
            <div class="progress-sub">
              <span id="estado-texto-respuestas" class="badge-state badge-bloqueado">
                Bloqueado
              </span>
            </div>
          </div>
          <button
            class="btn btn-primary btn-open"
            data-target="respuestas.html"
            id="btn-respuestas"
            disabled
          >
            Abrir m√≥dulo ‚Üí
          </button>
        </div>
      </article>

      <!-- 6. Auditor√≠a -->
      <article class="module-card" data-module="auditoria">
        <div>
          <div class="module-header-row">
            <div class="module-title">Auditor√≠a EC0301</div>
            <div class="step-pill">Paso 6 de 6</div>
          </div>
          <p class="module-body">
            Valida tu portafolio de evidencias contra los requisitos del est√°ndar.
          </p>
        </div>
        <div class="module-footer">
          <div>
            <div class="progress-text">
              Avance: <span id="avance-auditoria">0%</span>
            </div>
            <div class="progress-sub">
              <span id="estado-texto-auditoria" class="badge-state badge-bloqueado">
                Bloqueado
              </span>
            </div>
          </div>
          <button
            class="btn btn-primary btn-open"
            data-target="auditoria.html"
            id="btn-auditoria"
            disabled
          >
            Abrir m√≥dulo ‚Üí
          </button>
        </div>
      </article>

    </div>
  </div>

  <!-- Modal de error cr√≠tico -->
  <div id="critical-backdrop" class="critical-backdrop">
    <div class="critical-modal">
      <div class="critical-icon">‚úñ</div>
      <div class="critical-title">Error cr√≠tico del sistema</div>
      <p class="critical-body" id="critical-message">
        No se pudieron cargar los m√≥dulos de sistema <strong>auth.js</strong> o
        <strong>ec0301-data-manager.js</strong>.
      </p>
      <button id="critical-ok" class="btn btn-danger px-4">
        OK
      </button>
    </div>
  </div>

  <!-- ================== SCRIPTS ================== -->

  <!-- 1. M√≥dulos de sistema (rutas CORRECTAS, mismos directorio que acceso.html) -->
  <script src="./auth.js"></script>
  <script src="./ec0301-data-manager.js"></script>

  <!-- 2. L√≥gica de la pantalla de acceso -->
  <script>
    (function () {
      'use strict';

      // -------- Utilidades de error cr√≠tico --------
      const criticalBackdrop = document.getElementById('critical-backdrop');
      const criticalMessage = document.getElementById('critical-message');
      const criticalOk = document.getElementById('critical-ok');

      function showCriticalError(msg) {
        criticalMessage.innerHTML = msg;
        criticalBackdrop.style.display = 'flex';
      }

      criticalOk.addEventListener('click', function () {
        criticalBackdrop.style.display = 'none';
      });

      // -------- Verificaci√≥n de m√≥dulos base --------
      if (typeof window.auth === 'undefined' || typeof window.EC0301Manager === 'undefined') {
        showCriticalError(
          'No se pudieron cargar los m√≥dulos de sistema <strong>auth.js</strong> o ' +
          '<strong>ec0301-data-manager.js</strong>. Verifica las rutas de los archivos en el servidor.'
        );
        return;
      }

      // -------- Manejo de sesi√≥n --------
      const badgeEstado = document.getElementById('badge-estado');
      const btnLogout = document.getElementById('btnLogout');

      if (!auth.isLoggedIn()) {
        // Si no hay sesi√≥n, regresa al login principal
        window.location.href = 'index.html';
        return;
      } else {
        badgeEstado.textContent = 'Acceso activo';
        badgeEstado.classList.remove('status-loading');
        badgeEstado.classList.add('status-active');
      }

      btnLogout.addEventListener('click', function () {
        auth.logout();
      });

      // -------- L√≥gica de avance y bloqueo de m√≥dulos --------
      const data = EC0301Manager.getData() || {};
      const productos = data.productos || {};

      // Regla simple: si existe el producto en localStorage, lo consideramos 100%
      const hasCarta = !!productos.carta_descriptiva;
      const hasLogistica = !!productos.logistica;
      const hasEvaluaciones = !!productos.evaluaciones;
      const hasManuales = !!productos.manuales;
      const hasRespuestas = !!productos.respuestas;
      const hasAuditoria = !!productos.auditoria;

      function setModuleState(config) {
        const {
          prefix,
          enabled,
          percent,
          stateText,
          stateClass
        } = config;

        const avanceEl = document.getElementById('avance-' + prefix);
        const estadoEl = document.getElementById('estado-texto-' + prefix);
        const btn = document.getElementById('btn-' + prefix);

        if (!avanceEl || !estadoEl || !btn) return;

        avanceEl.textContent = (percent ?? 0) + '%';

        estadoEl.className = 'badge-state ' + stateClass;
        estadoEl.textContent = stateText;

        btn.disabled = !enabled;
      }

      // Carta Descriptiva (siempre desbloqueada)
      setModuleState({
        prefix: 'carta',
        enabled: true,
        percent: hasCarta ? 100 : 0,
        stateText: hasCarta ? 'Completo' : 'En progreso',
        stateClass: hasCarta ? 'badge-completo' : 'badge-en-progreso'
      });

      // Log√≠stica (depende de Carta)
      setModuleState({
        prefix: 'logistica',
        enabled: hasCarta,
        percent: hasLogistica ? 100 : 0,
        stateText: !hasCarta ? 'Bloqueado' : hasLogistica ? 'Completo' : 'En progreso',
        stateClass: !hasCarta ? 'badge-bloqueado' : hasLogistica ? 'badge-completo' : 'badge-en-progreso'
      });

      // Evaluaciones (depende de Log√≠stica)
      setModuleState({
        prefix: 'evaluaciones',
        enabled: hasCarta && hasLogistica,
        percent: hasEvaluaciones ? 100 : 0,
        stateText: !(hasCarta && hasLogistica)
          ? 'Bloqueado'
          : hasEvaluaciones
          ? 'Completo'
          : 'En progreso',
        stateClass: !(hasCarta && hasLogistica)
          ? 'badge-bloqueado'
          : hasEvaluaciones
          ? 'badge-completo'
          : 'badge-en-progreso'
      });

      // Manuales (depende de Evaluaciones)
      setModuleState({
        prefix: 'manuales',
        enabled: hasCarta && hasLogistica && hasEvaluaciones,
        percent: hasManuales ? 100 : 0,
        stateText: !(hasCarta && hasLogistica && hasEvaluaciones)
          ? 'Bloqueado'
          : hasManuales
          ? 'Completo'
          : 'En progreso',
        stateClass: !(hasCarta && hasLogistica && hasEvaluaciones)
          ? 'badge-bloqueado'
          : hasManuales
          ? 'badge-completo'
          : 'badge-en-progreso'
      });

      // Respuestas (depende de Manuales)
      setModuleState({
        prefix: 'respuestas',
        enabled: hasCarta && hasLogistica && hasEvaluaciones && hasManuales,
        percent: hasRespuestas ? 100 : 0,
        stateText: !(hasCarta && hasLogistica && hasEvaluaciones && hasManuales)
          ? 'Bloqueado'
          : hasRespuestas
          ? 'Completo'
          : 'En progreso',
        stateClass: !(hasCarta && hasLogistica && hasEvaluaciones && hasManuales)
          ? 'badge-bloqueado'
          : hasRespuestas
          ? 'badge-completo'
          : 'badge-en-progreso'
      });

      // Auditor√≠a (depende de Respuestas)
      setModuleState({
        prefix: 'auditoria',
        enabled: hasCarta && hasLogistica && hasEvaluaciones && hasManuales && hasRespuestas,
        percent: hasAuditoria ? 100 : 0,
        stateText: !(hasCarta && hasLogistica && hasEvaluaciones && hasManuales && hasRespuestas)
          ? 'Bloqueado'
          : hasAuditoria
          ? 'Completo'
          : 'En progreso',
        stateClass: !(hasCarta && hasLogistica && hasEvaluaciones && hasManuales && hasRespuestas)
          ? 'badge-bloqueado'
          : hasAuditoria
          ? 'badge-completo'
          : 'badge-en-progreso'
      });

      // Navegaci√≥n al hacer clic en "Abrir m√≥dulo"
      document.querySelectorAll('.btn-open').forEach(function (btn) {
        btn.addEventListener('click', function () {
          const target = btn.getAttribute('data-target');
          if (!btn.disabled && target) {
            window.location.href = target;
          }
        });
      });
    })();
  </script>
</body>
</html>
