<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillsCert EC0301 - Sistema Integral de Dise√±o de Cursos</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #ff6b35;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: #1e3a8a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }

        .logo-text h1 {
            color: #1e3a8a;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .logo-text p {
            color: #666;
            font-size: 14px;
        }

        .btn-sesion {
            background: #1e3a8a;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-sesion:hover {
            background: #152a6b;
            transform: translateY(-2px);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 200px);
            padding: 40px 20px;
            text-align: center;
        }

        .welcome-box {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 600px;
        }

        .welcome-box h2 {
            color: #1e3a8a;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .welcome-box p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .info-box {
            background: #f0f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
            border-radius: 8px;
        }

        .info-box strong {
            color: #1e3a8a;
        }

        .btn-pagar {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            padding: 18px 40px;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            margin-top: 20px;
        }

        .btn-pagar:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }

        .footer {
            background: rgba(0,0,0,0.2);
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: auto;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }
            
            .welcome-box {
                padding: 30px 20px;
            }

            .logo-text h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo-section">
            <div class="logo">üéì</div>
            <div class="logo-text">
                <h1>SkillsCert EC0301</h1>
                <p>Sistema Integral de Dise√±o de Cursos</p>
            </div>
        </div>
        <button class="btn-sesion" id="login-button">üîë Iniciar Sesi√≥n</button>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="welcome-box">
            <h2>Bienvenido a SkillsCert</h2>
            <p>
                Inicia sesi√≥n con el c√≥digo que recibiste por <strong>Email y WhatsApp</strong> para acceder a tu panel.
            </p>
            
            <div class="info-box">
                <strong>üìã ¬øC√≥mo funciona?</strong><br>
                1. Realiza el pago de $500 MXN<br>
                2. Recibir√°s un c√≥digo de 6 d√≠gitos<br>
                3. Usa ese c√≥digo para iniciar sesi√≥n<br>
                4. Accede por 90 d√≠as al sistema EC0301
            </div>

            <p>
                <strong>Si no tienes un c√≥digo, realiza el pago primero:</strong>
            </p>
            <button class="btn-pagar" id="payment-button">
                üí≥ Pagar Acceso (500 MXN)
            </button>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        ¬© 2024 SkillsCert EC0301. Sistema profesional de dise√±o de cursos de capacitaci√≥n.
    </footer>

    <!-- Scripts -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // ============================================================
        // CONFIGURACI√ìN
        // ============================================================
        const STRIPE_PUBLIC_KEY = 'pk_test_51SJ0gXFupe2fTa5zIRqzSldlQeprBkKE2fPMGDFGhdq5GDuBUOOKYRHUZG9jjAzPCZP0fCXmIOxDJpDn9U8X4z0x00K1WlLYIp'; // ‚ö†Ô∏è REEMPLAZA CON TU CLAVE P√öBLICA
        const BACKEND_URL = 'https://ec0301-globalskillscert-backend.onrender.com';

        console.log('‚úÖ Sistema iniciado');
        console.log('üåê Backend:', BACKEND_URL);

        // ============================================================
        // INICIALIZACI√ìN
        // ============================================================
        document.addEventListener('DOMContentLoaded', function() {
            const paymentButton = document.getElementById('payment-button');
            const loginButton = document.getElementById('login-button');

            // Verificar si ya hay sesi√≥n activa
            const existingToken = localStorage.getItem('authToken');
            if (existingToken) {
                console.log('üîë Token existente encontrado, verificando...');
                verifyExistingSession(existingToken);
            }

            // ============================================================
            // BOT√ìN DE PAGO
            // ============================================================
            if (paymentButton) {
                paymentButton.addEventListener('click', async function() {
                    console.log('üéØ Iniciando proceso de pago');

                    // Paso 1: Solicitar email
                    const { value: email } = await Swal.fire({
                        title: 'üìß Ingresa tu correo electr√≥nico',
                        input: 'email',
                        inputLabel: 'Recibir√°s tu c√≥digo de acceso aqu√≠',
                        inputPlaceholder: 'correo@ejemplo.com',
                        showCancelButton: true,
                        cancelButtonText: 'Cancelar',
                        confirmButtonText: 'Continuar',
                        confirmButtonColor: '#667eea',
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Debes ingresar un correo electr√≥nico';
                            }
                            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
                                return 'Por favor ingresa un correo v√°lido';
                            }
                        }
                    });

                    if (!email) {
                        console.log('‚ùå Proceso cancelado por el usuario');
                        return;
                    }

                    // Paso 2: Solicitar WhatsApp (opcional)
                    const { value: phone } = await Swal.fire({
                        title: 'üì± N√∫mero de WhatsApp (opcional)',
                        input: 'tel',
                        inputLabel: 'Para recibir tu c√≥digo tambi√©n por WhatsApp',
                        inputPlaceholder: '+52 55 1234 5678',
                        showCancelButton: true,
                        cancelButtonText: 'Omitir',
                        confirmButtonText: 'Proceder al pago',
                        confirmButtonColor: '#667eea',
                        allowOutsideClick: false
                    });

                    // Paso 3: Crear sesi√≥n de pago
                    Swal.fire({
                        title: 'Procesando...',
                        html: 'Preparando tu sesi√≥n de pago segura<br><small>Esto puede tomar unos segundos</small>',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    try {
                        console.log('üì° Conectando con backend...');
                        console.log('üìß Email:', email);
                        console.log('üì± Phone:', phone || 'No proporcionado');

                        const response = await fetch(`${BACKEND_URL}/create-checkout-session`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                email: email,
                                phone: phone || null
                            })
                        });

                        console.log('üì° Respuesta recibida:', response.status);

                        if (!response.ok) {
                            const errorData = await response.json();
                            console.error('‚ùå Error del servidor:', errorData);
                            throw new Error(errorData.error || 'Error al crear sesi√≥n de pago');
                        }

                        const session = await response.json();
                        console.log('‚úÖ Sesi√≥n creada exitosamente:', session.id);

                        // Paso 4: Redirigir a Stripe Checkout
                        console.log('üîÑ Redirigiendo a Stripe Checkout...');
                        const stripe = Stripe(STRIPE_PUBLIC_KEY);
                        const { error } = await stripe.redirectToCheckout({
                            sessionId: session.id
                        });

                        if (error) {
                            console.error('‚ùå Error de Stripe:', error);
                            throw error;
                        }

                    } catch (error) {
                        console.error('‚ùå Error completo:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al procesar el pago',
                            html: `
                                <p>${error.message || 'Error desconocido'}</p>
                                <small>Por favor intenta nuevamente o contacta a soporte</small>
                            `,
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#ef4444'
                        });
                    }
                });
            } else {
                console.error('‚ùå No se encontr√≥ el bot√≥n de pago');
            }

            // ============================================================
            // BOT√ìN DE LOGIN
            // ============================================================
            if (loginButton) {
                loginButton.addEventListener('click', async function() {
                    console.log('üîë Iniciando proceso de login');

                    const { value: accessCode } = await Swal.fire({
                        title: 'üîê Ingresa tu c√≥digo de acceso',
                        input: 'text',
                        inputLabel: 'C√≥digo de 6 d√≠gitos que recibiste por email/WhatsApp',
                        inputPlaceholder: '123456',
                        showCancelButton: true,
                        cancelButtonText: 'Cancelar',
                        confirmButtonText: 'Iniciar Sesi√≥n',
                        confirmButtonColor: '#667eea',
                        inputAttributes: {
                            maxlength: 6,
                            autocomplete: 'off'
                        },
                        inputValidator: (value) => {
                            if (!value) {
                                return 'Debes ingresar el c√≥digo';
                            }
                            if (!/^\d{6}$/.test(value)) {
                                return 'El c√≥digo debe tener exactamente 6 d√≠gitos';
                            }
                        }
                    });

                    if (!accessCode) {
                        console.log('‚ùå Login cancelado');
                        return;
                    }

                    Swal.fire({
                        title: 'Verificando...',
                        html: 'Validando tu c√≥digo de acceso<br><small>Por favor espera</small>',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    try {
                        console.log('üì° Validando c√≥digo:', accessCode);

                        const response = await fetch(`${BACKEND_URL}/validate-access-code`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                accessCode: accessCode
                            })
                        });

                        console.log('üì° Respuesta del servidor:', response.status);

                        const data = await response.json();

                        if (!response.ok) {
                            console.error('‚ùå Error de validaci√≥n:', data);
                            throw new Error(data.message || 'C√≥digo inv√°lido');
                        }

                        console.log('‚úÖ C√≥digo validado correctamente');
                        console.log('üë§ Usuario:', data.email);

                        // Guardar token en localStorage
                        localStorage.setItem('authToken', data.token);
                        localStorage.setItem('userEmail', data.email);
                        localStorage.setItem('sessionExpiry', data.expiresAt);

                        Swal.fire({
                            icon: 'success',
                            title: '¬°Bienvenido!',
                            html: `
                                <p>Acceso concedido exitosamente</p>
                                <small>Redirigiendo a tu panel...</small>
                            `,
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            console.log('üîÑ Redirigiendo al dashboard');
                            window.location.href = '/dashboard.html';
                        });

                    } catch (error) {
                        console.error('‚ùå Error de autenticaci√≥n:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de autenticaci√≥n',
                            html: `
                                <p>${error.message || 'C√≥digo inv√°lido o expirado'}</p>
                                <small>Verifica tu c√≥digo e intenta nuevamente</small>
                            `,
                            confirmButtonText: 'Intentar nuevamente',
                            confirmButtonColor: '#ef4444'
                        });
                    }
                });
            }
        });

        // ============================================================
        // VERIFICAR SESI√ìN EXISTENTE
        // ============================================================
        async function verifyExistingSession(token) {
            try {
                const response = await fetch(`${BACKEND_URL}/validate-token`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.valid) {
                    console.log('‚úÖ Sesi√≥n v√°lida detectada, redirigiendo...');
                    window.location.href = '/dashboard.html';
                } else {
                    console.log('‚ö†Ô∏è Sesi√≥n inv√°lida, limpiando localStorage');
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('sessionExpiry');
                }
            } catch (error) {
                console.error('‚ùå Error verificando sesi√≥n:', error);
            }
        }
    </script>
</body>
</html>
