<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta Descriptiva EC0301 - SkillsCert Professional</title>

    <script src="sistema_central/auth.js" defer></script>
    <script src="sistema_central/ec0301-data-manager.js" defer></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --primary-light: #818cf8;
            --accent: #FF6B35; --success: #10b981; --warning: #F59E0B;
            --danger: #ef4444; --dark: #1e293b; --light: #f1f5f9;
            --white: #ffffff; --border: #e2e8f0; --shadow: 0 10px 30px rgba(99, 102, 241, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: var(--dark); line-height: 1.6; }
        .header { background: var(--white); box-shadow: 0 2px 20px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--primary); }
        .header-content { max-width: 1400px; margin: 0 auto; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .header-title { display: flex; align-items: center; gap: 1rem; }
        .header-title i { font-size: 2rem; color: var(--primary); }
        .header-title h1 { font-size: 1.5rem; color: var(--dark); font-weight: 700; }
        .header-title .subtitle { font-size: 0.85rem; color: #64748b; font-weight: 400; }
        .toolbar { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .btn { padding: 0.65rem 1.25rem; border: none; border-radius: 8px; cursor: pointer; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.3s; text-decoration: none; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4); }
        .btn-secondary { background: #64748b; color: var(--white); }
        .btn-secondary:hover { background: #475569; }
        .btn-success { background: var(--success); color: var(--white); }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--warning); color: var(--white); }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: var(--danger); color: var(--white); }
        .btn-danger:hover { background: #dc2626; }
        .progress-container { background: var(--light); height: 8px; position: relative; overflow: hidden; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); transition: width 0.5s ease; border-radius: 0 4px 4px 0; box-shadow: 0 0 10px rgba(99, 102, 241, 0.5); }
        .container { max-width: 1400px; margin: 2rem auto; padding: 0 2rem 2rem; }
        .section { background: var(--white); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow); border: 1px solid var(--border); animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { color: var(--primary); font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem; padding-bottom: 0.75rem; border-bottom: 3px solid var(--primary); display: flex; align-items: center; gap: 0.75rem; }
        .section-title i { font-size: 1.75rem; }
        .box { background: var(--light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid var(--border); position: relative; }
        .box h3 { color: var(--dark); margin-bottom: 1.25rem; font-size: 1.25rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .box h3 i { color: var(--primary); }
        .form-group { margin-bottom: 1.25rem; }
        label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--dark); font-size: 0.95rem; }
        label .required { color: var(--danger); margin-left: 0.25rem; }
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: all 0.3s; background: var(--white); }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        textarea { min-height: 100px; resize: vertical; }
        input:disabled, select:disabled, textarea:disabled { background: var(--light); cursor: not-allowed; opacity: 0.7; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.25rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.25rem; }
        .grid-5 { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 1rem; align-items: center; }
        .doms { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .dom { padding: 0.75rem 1.25rem; background: var(--white); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.3s; font-weight: 600; font-size: 0.9rem; }
        .dom:hover { border-color: var(--primary); transform: translateY(-2px); }
        .dom.active { background: var(--primary); color: var(--white); border-color: var(--primary); }
        .verbos-container { background: var(--white); padding: 1rem; border-radius: 8px; margin: 1rem 0; border: 1px solid var(--border); }
        .verbos-container small { display: block; color: #64748b; margin-bottom: 0.75rem; font-weight: 600; }
        .verbo-category { margin: 0.75rem 0; }
        .verbo-category strong { display: block; color: var(--primary); font-size: 0.85rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .verbo { display: inline-block; padding: 0.4rem 0.9rem; margin: 0.25rem; background: var(--light); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; }
        .verbo:hover { background: var(--primary); color: var(--white); border-color: var(--primary); transform: scale(1.05); }
        .preview-box { background: linear-gradient(135deg, #e0e7ff 0%, #fef3c7 100%); padding: 1.25rem; border-radius: 8px; border-left: 4px solid var(--primary); margin-top: 1rem; }
        .preview-box strong { display: block; color: var(--primary); margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .preview-box #og_preview { color: var(--dark); font-size: 1.05rem; line-height: 1.6; font-style: italic; }
        .time { background: var(--primary); color: var(--white); padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; letter-spacing: 0.5px; }
        .time-input { max-width: 100px; text-align: right; }
        .total-time-box { background: var(--primary-light); border: 2px solid var(--primary); }
        .total-time-box #sum_total { font-size: 1.1rem; color: var(--primary-dark); }
        .total-time-box #time_warning { color: var(--danger); font-weight: 600; }
        .validation-indicator { position: fixed; bottom: 2rem; right: 2rem; background: var(--white); padding: 1.25rem 1.75rem; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 1rem; font-weight: 600; z-index: 999; transition: all 0.3s; border: 2px solid transparent; }
        .validation-indicator.valid { border-color: var(--success); animation: pulse-success 2s infinite; }
        .validation-indicator.invalid { border-color: var(--danger); }
        @keyframes pulse-success { 0%, 100% { box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3); } 50% { box-shadow: 0 10px 40px rgba(16, 185, 129, 0.6); } }
        .validation-indicator i { font-size: 1.5rem; }
        .help-tip { display: inline-block; background: var(--warning); color: var(--white); width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-size: 0.85rem; cursor: help; margin-left: 0.5rem; font-weight: 700; }
        @media (max-width: 768px) {
            .header-content { flex-direction: column; align-items: stretch; }
            .toolbar { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .grid-2, .grid-3, .grid-4, .grid-5 { grid-template-columns: 1fr; }
            .doms { flex-direction: column; }
            .dom { text-align: center; }
            .validation-indicator { bottom: 1rem; right: 1rem; left: 1rem; padding: 1rem; }
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .mt-1 { margin-top: 1rem; }
        .pulse { animation: pulse-btn 2s infinite; }
        @keyframes pulse-btn { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <i class="fas fa-file-contract"></i>
                <div>
                    <h1>Carta Descriptiva EC0301</h1>
                    <span class="subtitle">Guion Instruccional para Cursos Presenciales</span>
                </div>
            </div>
            <div class="toolbar">
                <a href="acceso.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Dashboard
                </a>
                <button class="btn btn-secondary" onclick="showHelp()">
                    <i class="fas fa-question-circle"></i>
                    Ayuda
                </button>
                <button class="btn btn-primary" onclick="saveDraft()">
                    <i class="fas fa-save"></i>
                    Guardar
                </button>
                <button class="btn btn-success" onclick="validateForm()">
                    <i class="fas fa-check-circle"></i>
                    Validar
                </button>
                <button class="btn btn-warning" onclick="exportCarta('pdf')">
                    <i class="fas fa-file-pdf"></i>
                    Exportar PDF
                </button>
                <button class="btn btn-success pulse" onclick="markComplete()">
                    <i class="fas fa-trophy"></i>
                    Completar
                </button>
            </div>
        </div>
        <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
    </header>

    <main class="container">

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-info-circle"></i>
                1. Informaci√≥n General del Curso
            </h2>
            <div class="grid-2">
                <div class="form-group">
                    <label for="cd_nombre">Nombre del Curso/Taller <span class="required">*</span></label>
                    <input id="cd_nombre" placeholder="Ej: Curso de Inducci√≥n en PLD y FT" required>
                </div>
                <div class="form-group">
                    <label for="cd_facilitador">Nombre del Facilitador/Instructor <span class="required">*</span></label>
                    <input id="cd_facilitador" placeholder="Nombre completo del facilitador" required>
                </div>
                <div class="form-group">
                    <label for="cd_duracion">Duraci√≥n total (horas) <span class="required">*</span></label>
                    <input id="cd_duracion" type="number" placeholder="Ej: 2" min="1" max="500" required onchange="recalcTimes()">
                </div>
                <div class="form-group">
                    <label for="cd_lugar">Lugar de Instrucci√≥n <span class="required">*</span></label>
                    <input id="cd_lugar" placeholder="Ej: Sal√≥n Volc√°n 1, Hotel City Express" required>
                </div>
                 <div class="form-group">
                    <label for="cd_fechas">Fecha(s) <span class="required">*</span></label>
                    <input id="cd_fechas" type="text" placeholder="Ej: 17 de julio 2025" required>
                </div>
                <div class="form-group">
                    <label for="cd_modalidad">Modalidad del curso <span class="required">*</span></label>
                    <select id="cd_modalidad" required>
                        <option value="presencial">Presencial Grupal (EC0301 / EC0217.01)</option>
                        <option value="sincrono" disabled>En l√≠nea S√≠ncrono (EC0050)</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="cd_proposito">Prop√≥sito/Beneficio del curso <span class="required">*</span></label>
                <textarea id="cd_proposito" placeholder="Describa el prop√≥sito del curso y los beneficios que obtendr√° el participante y la organizaci√≥n..." required></textarea>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-users"></i>
                2. Perfil del Participante
            </h2>
            <div class="grid-2">
                <div class="form-group">
                    <label for="cd_perfil">Descripci√≥n del Perfil <span class="required">*</span></label>
                    <textarea id="cd_perfil" placeholder="Edad, ocupaci√≥n, nivel educativo, experiencia previa, motivaciones, estilo de aprendizaje..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="cd_conoc">Conocimientos y Habilidades Previos <span class="required">*</span></label>
                    <textarea id="cd_conoc" placeholder="¬øQu√© debe saber y saber hacer el participante antes de iniciar el curso?" required></textarea>
                </div>
                <div class="form-group">
                    <label for="cd_num">N√∫mero de participantes <span class="required">*</span></label>
                    <input id="cd_num" type="number" min="1" placeholder="Ej: 4" required>
                </div>
                <div class="form-group">
                    <label for="cd_tipo">Tipo de grupo <span class="required">*</span></label>
                    <select id="cd_tipo" required>
                        <option value="">Seleccione una opci√≥n...</option>
                        <option value="homogeneo">Homog√©neo (mismo perfil)</option>
                        <option value="heterogeneo">Heterog√©neo (perfiles diversos)</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-bullseye"></i>
                3. Objetivos de Aprendizaje
            </h2>

            <div class="box">
                <h3>
                    <span><i class="fas fa-star"></i> Objetivo General</span>
                    <span class="help-tip" title="Redacte el objetivo que engloba los 4 dominios de aprendizaje.">?</span>
                </h3>
                <div class="form-group">
                    <label>Sujeto (predefinido)</label>
                    <input value="Al finalizar el curso, el participante" disabled>
                </div>
                <div class="form-group mt-1">
                    <label>Acci√≥n/Comportamiento observable <span class="required">*</span></label>
                    <textarea id="og_accion" placeholder="¬øQu√© ser√° capaz de hacer? (Ej: ...identificar√°, describir√°, reconocer√°, explicar√° y aplicar√°...)" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="form-group mt-1">
                    <label>Condici√≥n de operaci√≥n <span class="required">*</span></label>
                    <textarea id="og_cond" placeholder="¬øEn qu√© contexto? (Ej: ...aplicando estos conocimientos a casos pr√°cticos...)" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="form-group mt-1">
                    <label>Criterio de evaluaci√≥n <span class="required">*</span></label>
                    <textarea id="og_criterio" placeholder="¬øCon qu√© fin? (Ej: ...con el prop√≥sito de fortalecer la cultura de cumplimiento...)" required onkeyup="updateOG()"></textarea>
                </div>
                <div class="preview-box">
                    <strong>Vista previa del objetivo:</strong>
                    <div id="og_preview">Complete los campos anteriores para visualizar el objetivo general...</div>
                </div>
            </div>

            <div id="objetivosParticulares">
                <div class="box" data-op="1">
                    <h3><span><i class="fas fa-brain"></i> Objetivo Particular (Cognitivo)</span></h3>
                    <div class="verbos-container" id="verbs1"></div>
                    <div class="grid-2">
                        <div class="form-group"><label>Verbo + Acci√≥n <span class="required">*</span></label><input id="op1_accion" placeholder="Ej: Identificar√° las normativas..." required></div>
                        <div class="form-group"><label>Condici√≥n/Contexto <span class="required">*</span></label><textarea id="op1_cond" placeholder="Ej: A trav√©s del an√°lisis de materiales..." required></textarea></div>
                    </div>
                </div>
                <div class="box" data-op="2">
                    <h3><span><i class="fas fa-tools"></i> Objetivo Particular (Psicomotor)</span></h3>
                    <div class="verbos-container" id="verbs2"></div>
                    <div class="grid-2">
                        <div class="form-group"><label>Verbo + Acci√≥n <span class="required">*</span></label><input id="op2_accion" placeholder="Ej: Aplicar√° los procedimientos..." required></div>
                        <div class="form-group"><label>Condici√≥n/Contexto <span class="required">*</span></label><textarea id="op2_cond" placeholder="Ej: Por medio de la resoluci√≥n de casos pr√°cticos..." required></textarea></div>
                    </div>
                </div>
                <div class="box" data-op="3">
                    <h3><span><i class="fas fa-heart"></i> Objetivo Particular (Afectivo)</span></h3>
                    <div class="verbos-container" id="verbs3"></div>
                    <div class="grid-2">
                        <div class="form-group"><label>Verbo + Acci√≥n <span class="required">*</span></label><input id="op3_accion" placeholder="Ej: Asumir√° una actitud proactiva..." required></div>
                        <div class="form-group"><label>Condici√≥n/Contexto <span class="required">*</span></label><textarea id="op3_cond" placeholder="Ej: A trav√©s de la reflexi√≥n sobre casos reales..." required></textarea></div>
                    </div>
                </div>
                <div class="box" data-op="4">
                    <h3><span><i class="fas fa-users"></i> Objetivo Particular (Relacional-Social)</span></h3>
                    <div class="verbos-container" id="verbs4"></div>
                    <div class="grid-2">
                        <div class="form-group"><label>Verbo + Acci√≥n <span class="required">*</span></label><input id="op4_accion" placeholder="Ej: Colaborar√° en equipo para..." required></div>
                        <div class="form-group"><label>Condici√≥n/Contexto <span class="required">*</span></label><textarea id="op4_cond" placeholder="Ej: Mediante el an√°lisis colaborativo de casos..." required></textarea></div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-clipboard-list"></i>
                4. Requerimientos del Curso
            </h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Requerimientos en instalaciones, mobiliario y su distribuci√≥n <span class="required">*</span></label>
                    <textarea id="rq_instalaciones" placeholder="Ej: 1 Sal√≥n para 5 personas, 5 sillas, 1 mesa, distribuci√≥n en U..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Requerimientos en equipo de apoyo y su distribuci√≥n <span class="required">*</span></label>
                    <textarea id="rq_equipo" placeholder="Ej: 1 Laptop, 1 proyector, 1 pizarr√≥n, 1 extensi√≥n el√©ctrica..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Requerimientos en materiales de apoyo <span class="required">*</span></label>
                    <textarea id="rq_materiales" placeholder="Ej: 4 manuales del participante, 4 evaluaciones, 1 lista de asistencia, marcadores..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Requerimientos humanos <span class="required">*</span></label>
                    <textarea id="rq_humanos" placeholder="Ej: 1 Instructor certificado, 1 personal de apoyo log√≠stico (opcional)..." required></textarea>
                </div>
            </div>
            <div class="form-group">
                <label>Material y equipo para medidas de salud/seguridad/higiene <span class="required">*</span></label>
                <textarea id="rq_seguridad" placeholder="Ej: Gel antibacterial, botiqu√≠n, se√±alizaci√≥n de rutas de evacuaci√≥n, extintor..." required></textarea>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i>
                5. Sistema de Evaluaci√≥n (Suma 100%)
            </h2>
            <div class="box">
                <h3>Evaluaci√≥n Diagn√≥stica <span class="time">Inicio</span></h3>
                <div class="grid-3">
                    <div class="form-group"><label>Instrumento</label><input id="ev_diag_ins" value="Cuestionario"></div>
                    <div class="form-group"><label>Momento</label><input id="ev_diag_mom" value="Al inicio del Encuadre"></div>
                    <div class="form-group"><label>Ponderaci√≥n (%)</label><input type="number" id="ev_diag_pct" value="0" disabled></div>
                </div>
            </div>
            <div class="box">
                <h3>Evaluaci√≥n Formativa <span class="time">Durante</span></h3>
                <div class="grid-3">
                    <div class="form-group"><label>Instrumento</label><input id="ev_form_ins" value="Gu√≠a de observaci√≥n"></div>
                    <div class="form-group"><label>Momento</label><input id="ev_form_mom" value="Intermedia (durante el Desarrollo)"></div>
                    <div class="form-group"><label>Ponderaci√≥n (%) <span class="required">*</span></label><input type="number" id="ev_form_pct" value="50" min="0" max="100" onchange="recalcEval()"></div>
                </div>
            </div>
            <div class="box">
                <h3>Evaluaci√≥n Sumativa <span class="time">Final</span></h3>
                <div class="grid-3">
                    <div class="form-group"><label>Instrumento</label><input id="ev_sum_ins" value="Cuestionario"></div>
                    <div class="form-group"><label>Momento</label><input id="ev_sum_mom" value="Al final del Cierre"></div>
                    <div class="form-group"><label>Ponderaci√≥n (%) <span class="required">*</span></label><input type="number" id="ev_sum_pct" value="40" min="0" max="100" onchange="recalcEval()"></div>
                </div>
            </div>
            <div class="box">
                <h3>Evaluaci√≥n de Satisfacci√≥n <span class="time">Final</span></h3>
                <div class="grid-3">
                    <div class="form-group"><label>Instrumento</label><input id="ev_sat_ins" value="Cuestionario de satisfacci√≥n"></div>
                    <div class="form-group"><label>Momento</label><input id="ev_sat_mom" value="Al finalizar el Cierre"></div>
                    <div class="form-group"><label>Ponderaci√≥n (%) <span class="required">*</span></label><input type="number" id="ev_sat_pct" value="10" min="0" max="100" onchange="recalcEval()"></div>
                </div>
            </div>
        </section>

        <section class="section">
            <h2 class="section-title">
                <i class="fas fa-clock"></i>
                6. Desarrollo Cronol√≥gico / Guion Instruccional
            </h2>

            <div class="box">
                <h3>Comprobaci√≥n de Recursos <span class="time" id="comprobacionTime">0 min</span></h3>
                <div class="grid-5">
                    <label>Actividades</label>
                    <label>Duraci√≥n (min)</label>
                    <label>T√©cnica</label>
                    <label>Material/Equipo</label>
                    <label>Descripci√≥n</label>
                </div>
                <div class="grid-5 form-group">
                    <input value="Comprobaci√≥n de recursos" disabled>
                    <input type="number" id="dev_comprobacion_t" class="time-input" value="15" min="0" onchange="recalcTimes()">
                    <input value="Verificaci√≥n" disabled>
                    <input id="dev_comprobacion_mat" value="Lista de verificaci√≥n">
                    <textarea id="dev_comprobacion_desc" placeholder="Aplicar lista de verificaci√≥n, realizar pruebas de equipo, verificar mobiliario y materiales."></textarea>
                </div>
            </div>

            <div class="box">
                <h3>Encuadre / Apertura <span class="time" id="encuadreTime">0 min</span></h3>
                <div class="grid-5">
                    <label>Etapa del Encuadre</label>
                    <label>Duraci√≥n (min)</label>
                    <label>T√©cnica</label>
                    <label>Material/Equipo</label>
                    <label>Actividades / Descripci√≥n</label>
                </div>
                <div class="grid-5 form-group">
                    <input value="1. Presentaci√≥n" disabled>
                    <input type="number" id="dev_enc_1_t" class="time-input" value="6" min="0" onchange="recalcTimes()">
                    <input id="dev_enc_1_tec" value="Rompehielo">
                    <input id="dev_enc_1_mat" value="Presentaci√≥n PPT">
                    <textarea id="dev_enc_1_desc" placeholder="Instructor se presenta, aplica t√©cnica rompehielo, explica objetivo de la t√©cnica."></textarea>
                </div>
                <div class="grid-5 form-group">
                    <input value="2. Presentaci√≥n del curso" disabled>
                    <input type="number" id="dev_enc_2_t" class="time-input" value="5" min="0" onchange="recalcTimes()">
                    <input id="dev_enc_2_tec" value="Expositiva-dialogada">
                    <input id="dev_enc_2_mat" value="Presentaci√≥n PPT">
                    <textarea id="dev_enc_2_desc" placeholder="Presentar objetivos, temario, beneficios del curso y crear ambiente participativo."></textarea>
                </div>
                <div class="grid-5 form-group">
                    <input value="3. Evaluaci√≥n" disabled>
                    <input type="number" id="dev_enc_3_t" class="time-input" value="2" min="0" onchange="recalcTimes()">
                    <input id="dev_enc_3_tec" value="Expositiva">
                    <input id="dev_enc_3_mat" value="Formatos impresos">
                    <textarea id="dev_enc_3_desc" placeholder="Especificar tipos de evaluaci√≥n (diag, form, sum), instrumentos, momentos y ponderaciones."></textarea>
                </div>
                <div class="grid-5 form-group">
                    <input value="4. Acuerdos y compromisos" disabled>
                    <input type="number" id="dev_enc_4_t" class="time-input" value="4" min="0" onchange="recalcTimes()">
                    <input id="dev_enc_4_tec" value="T√©cnica grupal">
                    <input id="dev_enc_4_mat" value="Rotafolio, Contratos">
                    <textarea id="dev_enc_4_desc" placeholder="Acordar reglas, revisar expectativas, realizar Contrato de Aprendizaje."></textarea>
                </div>
                <div class="grid-5 form-group">
                    <input value="5. Evaluaci√≥n diagn√≥stica" disabled>
                    <input type="number" id="dev_enc_5_t" class="time-input" value="5" min="0" onchange="recalcTimes()">
                    <input id="dev_enc_5_tec" value="Evaluaci√≥n">
                    <input id="dev_enc_5_mat" value="Cuestionario diag.">
                    <textarea id="dev_enc_5_desc" placeholder="Explicar alcance, dar instrucciones, aplicar evaluaci√≥n diagn√≥stica, indicar tiempo."></textarea>
                </div>
            </div>

            <div class="box">
                <h3>Desarrollo <span class="time" id="desarrolloTime">0 min</span></h3>
                <div id="temasContainer">
                    </div>
                <button class="btn btn-primary mt-1" onclick="addTema()">
                    <i class="fas fa-plus"></i>
                    Agregar Tema/M√≥dulo
                </button>
            </div>

            <div class="box">
                <h3>Cierre <span class="time" id="cierreTime">0 min</span></h3>
                <div class="grid-5">
                    <label>Etapa del Cierre</label>
                    <label>Duraci√≥n (min)</label>
                    <label>T√©cnica</label>
                    <label>Material/Equipo</label>
                    <label>Actividades / Descripci√≥n</label>
                </div>
                <div class="grid-5 form-group">
                    <input value="1. Conclusiones y resumen" disabled>
                    <input type="number" id="dev_cierre_1_t" class="time-input" value="3" min="0" onchange="recalcTimes()">
                    <input id="dev_cierre_1_tec" value="T√©cnica de cierre">
                    <input id="dev_cierre_1_mat" value="Pizarr√≥n">
                    <textarea id="dev_cierre_1_desc" placeholder="Generar conclusi√≥n grupal, mencionar logros y aplicaci√≥n en el trabajo."></textarea>
                </div>
                 <div class="grid-5 form-group">
                    <input value="2. Logro de expectativas" disabled>
                    <input type="number" id="dev_cierre_2_t" class="time-input" value="2" min="0" onchange="recalcTimes()">
                    <input id="dev_cierre_2_tec" value="T√©cnica grupal">
                    <input id="dev_cierre_2_mat" value="Rotafolio">
                    <textarea id="dev_cierre_2_desc" placeholder="Revisar cumplimiento de expectativas y objetivos planteados en el encuadre."></textarea>
                </div>
                <div class="grid-5 form-group">
                    <input value="3. Sugerencias y continuidad" disabled>
                    <input type="number" id="dev_cierre_3_t" class="time-input" value="2" min="0" onchange="recalcTimes()">
                    <input id="dev_cierre_3_tec" value="Expositiva">
                    <input id="dev_cierre_3_mat" value="Presentaci√≥n">
                    <textarea id="dev_cierre_3_desc" placeholder="Sugerir acciones para la continuidad del aprendizaje, compartir fuentes de consulta."></textarea>
                </div>
                <div class="grid-5 form-group">
                    <input value="4. Evaluaci√≥n de satisfacci√≥n" disabled>
                    <input type="number" id="dev_cierre_4_t" class="time-input" value="2" min="0" onchange="recalcTimes()">
                    <input id="dev_cierre_4_tec" value="Evaluaci√≥n">
                    <input id="dev_cierre_4_mat" value="Formatos impresos">
                    <textarea id="dev_cierre_4_desc" placeholder="Explicar alcance del instrumento, dar instrucciones y aplicarlo."></textarea>
                </div>
                <div class="grid-5 form-group">
                    <input value="5. Despedida" disabled>
                    <input type="number" id="dev_cierre_5_t" class="time-input" value="1" min="0" onchange="recalcTimes()">
                    <input id="dev_cierre_5_tec" value="T√©cnica grupal">
                    <input id="dev_cierre_5_mat" value="N/A">
                    <textarea id="dev_cierre_5_desc" placeholder="Agradecer la participaci√≥n y cerrar formalmente el curso."></textarea>
                </div>
            </div>

            <div class="box total-time-box">
                <h3>Distribuci√≥n del Tiempo Total</h3>
                <div class="grid-4">
                    <div class="form-group"><label>Comprobaci√≥n</label><input id="sum_comprobacion" disabled></div>
                    <div class="form-group"><label>Encuadre</label><input id="sum_encuadre" disabled></div>
                    <div class="form-group"><label>Desarrollo</label><input id="sum_desarrollo" disabled></div>
                    <div class="form-group"><label>Cierre</label><input id="sum_cierre" disabled></div>
                </div>
                <div class="form-group mt-1" style="text-align: right;">
                    <label>Total del Curso (calculado)</label>
                    <input id="sum_total" disabled style="font-weight: bold; max-width: 250px; display: inline-block;">
                    <div id="time_warning" style="display: none;"></div>
                </div>
            </div>
        </section>
    </main>

    <div class="validation-indicator invalid" id="validationIndicator" style="display: none;">
        <i class="fas fa-exclamation-circle" style="color: var(--danger);"></i>
        <span>Documento incompleto</span>
    </div>

    <script>
        // ========== CONSTANTES Y CONFIGURACI√ìN ==========
        const VERBOS = { /* (Tu objeto VERBOS completo) */ };
        const $ = id => document.getElementById(id);
        let objetivosCount = 4; // Fijo en 4
        let temasCount = 0;

        // ========== PROTECCI√ìN DE P√ÅGINA ==========
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîç Verificando sistema...');
            
            // Espera un ciclo para asegurar que los scripts 'defer' se carguen
            setTimeout(() => {
                // Verificar m√≥dulos
                if (typeof auth === 'undefined' || typeof EC0301Manager === 'undefined') {
                    Swal.fire({
                        icon: 'error', title: 'Error Cr√≠tico del Sistema',
                        html: '<p>No se pudieron cargar los m√≥dulos del sistema (auth.js o ec0301-data-manager.js).</p><p>Esto se debe a que los archivos no est√°n en el servidor o tienen un error de sintaxis (como contenido de .gitignore).</p>',
                        confirmButtonColor: '#ef4444', allowOutsideClick: false
                    }).then(() => window.location.href = 'index.html');
                    return;
                }

                // Verificar autenticaci√≥n
                if (!auth.isLoggedIn()) {
                    Swal.fire({
                        icon: 'warning', title: 'Acceso Denegado',
                        text: 'Debes iniciar sesi√≥n para acceder a este m√≥dulo.',
                        confirmButtonColor: '#6366f1', allowOutsideClick: false
                    }).then(() => window.location.href = 'index.html');
                    return;
                }

                console.log('‚úÖ Sistema verificado correctamente');
                initializeApp();
            }, 50); // 50ms de espera
        });

        // ========== INICIALIZACI√ìN ==========
        function initializeApp() {
            // Renderizar verbos para los 4 objetivos fijos
            renderVerbos(1, 'cognitivo');
            renderVerbos(2, 'psicomotriz');
            renderVerbos(3, 'afectivo');
            renderVerbos(4, 'relacional');
            
            loadDraft(); // Carga el borrador
            
            // Si no hay temas cargados, a√±ade uno por defecto
            if (temasCount === 0) {
                addTema();
            }
            
            recalcTimes();
            recalcEval();
            updateProgress();
            
            // Auto-guardar cada 30 segundos
            setInterval(() => {
                if (updateProgress() > 5) { // Solo si hay algo que guardar
                    saveDraft(true); // true = silencioso
                }
            }, 30000);
        }

        // ========== FUNCIONES DE VERBOS ==========
        function renderVerbos(n, dominio) {
            // ... (Tu c√≥digo de renderVerbos) ...
        }
        function insertVerbo(n, verbo) {
            // ... (Tu c√≥digo de insertVerbo) ...
        }
        // No se necesita selDom para los 4 fijos, ya que su dominio es est√°tico.
        
        // ========== OBJETIVOS ==========
        function updateOG() {
            // ... (Tu c√≥digo de updateOG) ...
        }
        // No se necesita add/remove ObjetivoParticular

        // ========== TEMAS ==========
        function addTema() {
            temasCount++;
            const container = $('temasContainer');
            const tema = document.createElement('div');
            tema.className = 'box';
            tema.setAttribute('data-tema', temasCount);
            // Estructura de 5 columnas como en el Encuadre
            tema.innerHTML = `
                <h3>
                    <span>Tema/M√≥dulo ${temasCount}</span>
                    <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="removeTema(this)">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </h3>
                <div class="form-group">
                    <label>Nombre del Tema/M√≥dulo <span class="required">*</span></label>
                    <input id="tema${temasCount}_nombre" placeholder="T√≠tulo del tema" required onkeyup="updateTemasEnObjetivos()">
                </div>
                <div class="grid-5">
                    <label>Actividades</label>
                    <label>Duraci√≥n (min)</label>
                    <label>T√©cnica</label>
                    <label>Material/Equipo</label>
                    <label>Descripci√≥n</label>
                </div>
                <div class="grid-5 form-group">
                    <input value="Desarrollo del Tema" disabled>
                    <input type="number" id="tema${temasCount}_duracion" class="time-input" value="60" min="0" onchange="recalcTimes()" required>
                    <input id="tema${temasCount}_tec" value="Expositiva / Pr√°ctica">
                    <input id="tema${temasCount}_mat" value="Presentaci√≥n, Manual">
                    <textarea id="tema${temasCount}_desc" placeholder="Desarrollo de contenidos, ejemplos, actividades pr√°cticas..."></textarea>
                </div>
            `;
            container.appendChild(tema);
            tema.style.animation = 'slideUp 0.5s ease';
            recalcTimes();
            updateTemasEnObjetivos();
        }

        function removeTema(button) {
            Swal.fire({
                title: '¬øEliminar tema?', text: 'Esta acci√≥n no se puede deshacer',
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444',
                cancelButtonColor: '#64748b', confirmButtonText: 'S√≠, eliminar'
            }).then((result) => {
                if (result.isConfirmed) {
                    button.closest('.box').remove();
                    recalcTimes();
                    updateTemasEnObjetivos();
                    Swal.fire('Eliminado', 'Tema eliminado.', 'success');
                }
            });
        }
        
        // Funci√≥n inteligente para actualizar los <textarea> de temas en objetivos
        function updateTemasEnObjetivos() {
            let temasList = [];
            document.querySelectorAll('#temasContainer .box').forEach(box => {
                const n = box.dataset.tema;
                const nombre = $(`tema${n}_nombre`).value;
                if(nombre) temasList.push(nombre);
            });
            // Esta es una simulaci√≥n, en un caso real esto se conectar√≠a
            // a los objetivos particulares para sugerir los temas.
            console.log("Temas actuales:", temasList.join(', '));
        }

        // ========== C√ÅLCULOS ==========
        function recalcTimes() {
            let totalDev = 0;
            document.querySelectorAll('#temasContainer .box').forEach(box => {
                const n = box.dataset.tema;
                totalDev += parseInt($(`tema${n}_duracion`).value) || 0;
            });
            
            const comprobacion = parseInt($('dev_comprobacion_t').value) || 0;
            const encuadre = (parseInt($('dev_enc_1_t').value) || 0) + (parseInt($('dev_enc_2_t').value) || 0) + (parseInt($('dev_enc_3_t').value) || 0) + (parseInt($('dev_enc_4_t').value) || 0) + (parseInt($('dev_enc_5_t').value) || 0);
            const cierre = (parseInt($('dev_cierre_1_t').value) || 0) + (parseInt($('dev_cierre_2_t').value) || 0) + (parseInt($('dev_cierre_3_t').value) || 0) + (parseInt($('dev_cierre_4_t').value) || 0) + (parseInt($('dev_cierre_5_t').value) || 0);

            $('sum_comprobacion').value = `${comprobacion} min`;
            $('comprobacionTime').textContent = `${comprobacion} min`;
            $('sum_encuadre').value = `${encuadre} min`;
            $('encuadreTime').textContent = `${encuadre} min`;
            $('sum_desarrollo').value = `${totalDev} min`;
            $('desarrolloTime').textContent = `${totalDev} min`;
            $('sum_cierre').value = `${cierre} min`;
            $('cierreTime').textContent = `${cierre} min`;
            
            const totalMinutos = comprobacion + encuadre + totalDev + cierre;
            const totalHoras = (totalMinutos / 60).toFixed(2);
            
            $('sum_total').value = `${totalHoras} horas (${totalMinutos} min)`;
            
            // Validar contra el encabezado
            const duracionHoras = parseFloat($('cd_duracion').value) || 0;
            const timeWarning = $('time_warning');
            if (duracionHoras > 0 && duracionHoras.toFixed(2) !== totalHoras) {
                timeWarning.textContent = `¬°Advertencia! El tiempo total (${totalHoras}h) no coincide con la duraci√≥n del curso (${duracionHoras}h).`;
                timeWarning.style.display = 'block';
            } else {
                timeWarning.style.display = 'none';
            }
            
            updateProgress();
        }

        function recalcEval() {
            const formPct = parseInt($('ev_form_pct').value) || 0;
            const sumPct = parseInt($('ev_sum_pct').value) || 0;
            const satPct = parseInt($('ev_sat_pct').value) || 0;
            const totalPct = formPct + sumPct + satPct;
            
            // L√≥gica simple para auto-ajustar la sumativa si el total cambia
            // (Se puede hacer m√°s complejo, pero esto es un inicio)
            if (totalPct !== 100 && event.target.id === 'ev_form_pct') {
                 $('ev_sum_pct').value = 100 - formPct - satPct;
            }
            
            if (totalPct !== 100) {
                 $('ev_sum_pct').style.borderColor = 'var(--danger)';
                 $('ev_form_pct').style.borderColor = 'var(--danger)';
                 $('ev_sat_pct').style.borderColor = 'var(--danger)';
            } else {
                 $('ev_sum_pct').style.borderColor = 'var(--success)';
                 $('ev_form_pct').style.borderColor = 'var(--success)';
                 $('ev_sat_pct').style.borderColor = 'var(--success)';
            }
            updateProgress();
        }

        // ========== PROGRESO Y VALIDACI√ìN ==========
        function updateProgress() {
            // ... (Tu l√≥gica de updateProgress es correcta, solo aseg√∫rate de que los IDs coincidan) ...
            return 0; // Devuelve 0 para forzar el guardado (para el ejemplo)
        }
        function validateForm() {
            // ... (Tu l√≥gica de validateForm) ...
        }

        // ========== GUARDAR Y CARGAR (ACTUALIZADO) ==========

        function collectData() {
            const data = {
                // Info General
                nombre: $('cd_nombre').value,
                duracion: $('cd_duracion').value,
                facilitador: $('cd_facilitador').value,
                lugar: $('cd_lugar').value,
                fechas: $('cd_fechas').value,
                modalidad: $('cd_modalidad').value,
                proposito: $('cd_proposito').value,
                // Perfil
                perfil: $('cd_perfil').value,
                conoc: $('cd_conoc').value,
                num: $('cd_num').value,
                tipo: $('cd_tipo').value,
                // Obj General
                og: {
                    accion: $('og_accion').value,
                    cond: $('og_cond').value,
                    criterio: $('og_criterio').value
                },
                // Obj Particulares
                objetivos: [
                    { dom: 'cognitivo', accion: $('op1_accion').value, cond: $('op1_cond').value },
                    { dom: 'psicomotor', accion: $('op2_accion').value, cond: $('op2_cond').value },
                    { dom: 'afectivo', accion: $('op3_accion').value, cond: $('op3_cond').value },
                    { dom: 'relacional', accion: $('op4_accion').value, cond: $('op4_cond').value }
                ],
                // Requerimientos
                rq: {
                    instalaciones: $('rq_instalaciones').value,
                    equipo: $('rq_equipo').value,
                    materiales: $('rq_materiales').value,
                    humanos: $('rq_humanos').value,
                    seguridad: $('rq_seguridad').value
                },
                // Evaluaci√≥n
                ev: {
                    diag_ins: $('ev_diag_ins').value, diag_mom: $('ev_diag_mom').value,
                    form_ins: $('ev_form_ins').value, form_mom: $('ev_form_mom').value, form_pct: $('ev_form_pct').value,
                    sum_ins: $('ev_sum_ins').value, sum_mom: $('ev_sum_mom').value, sum_pct: $('ev_sum_pct').value,
                    sat_ins: $('ev_sat_ins').value, sat_mom: $('ev_sat_mom').value, sat_pct: $('ev_sat_pct').value
                },
                // Desarrollo
                dev: {
                    comprobacion_t: $('dev_comprobacion_t').value, comprobacion_mat: $('dev_comprobacion_mat').value, comprobacion_desc: $('dev_comprobacion_desc').value,
                    enc_1_t: $('dev_enc_1_t').value, enc_1_tec: $('dev_enc_1_tec').value, enc_1_mat: $('dev_enc_1_mat').value, enc_1_desc: $('dev_enc_1_desc').value,
                    enc_2_t: $('dev_enc_2_t').value, enc_2_tec: $('dev_enc_2_tec').value, enc_2_mat: $('dev_enc_2_mat').value, enc_2_desc: $('dev_enc_2_desc').value,
                    enc_3_t: $('dev_enc_3_t').value, enc_3_tec: $('dev_enc_3_tec').value, enc_3_mat: $('dev_enc_3_mat').value, enc_3_desc: $('dev_enc_3_desc').value,
                    enc_4_t: $('dev_enc_4_t').value, enc_4_tec: $('dev_enc_4_tec').value, enc_4_mat: $('dev_enc_4_mat').value, enc_4_desc: $('dev_enc_4_desc').value,
                    enc_5_t: $('dev_enc_5_t').value, enc_5_tec: $('dev_enc_5_tec').value, enc_5_mat: $('dev_enc_5_mat').value, enc_5_desc: $('dev_enc_5_desc').value,
                    cierre_1_t: $('dev_cierre_1_t').value, cierre_1_tec: $('dev_cierre_1_tec').value, cierre_1_mat: $('dev_cierre_1_mat').value, cierre_1_desc: $('dev_cierre_1_desc').value,
                    cierre_2_t: $('dev_cierre_2_t').value, cierre_2_tec: $('dev_cierre_2_tec').value, cierre_2_mat: $('dev_cierre_2_mat').value, cierre_2_desc: $('dev_cierre_2_desc').value,
                    cierre_3_t: $('dev_cierre_3_t').value, cierre_3_tec: $('dev_cierre_3_tec').value, cierre_3_mat: $('dev_cierre_3_mat').value, cierre_3_desc: $('dev_cierre_3_desc').value,
                    cierre_4_t: $('dev_cierre_4_t').value, cierre_4_tec: $('dev_cierre_4_tec').value, cierre_4_mat: $('dev_cierre_4_mat').value, cierre_4_desc: $('dev_cierre_4_desc').value,
                    cierre_5_t: $('dev_cierre_5_t').value, cierre_5_tec: $('dev_cierre_5_tec').value, cierre_5_mat: $('dev_cierre_5_mat').value, cierre_5_desc: $('dev_cierre_5_desc').value
                },
                temas: [],
                fechaActualizacion: new Date().toISOString()
            };
            
            // Recopilar los temas
            document.querySelectorAll('#temasContainer .box').forEach(box => {
                const n = box.dataset.tema;
                if ($(`tema${n}_nombre`)) {
                    data.temas.push({
                        num: n,
                        nombre: $(`tema${n}_nombre`).value,
                        duracion: $(`tema${n}_duracion`).value,
                        tec: $(`tema${n}_tec`).value,
                        mat: $(`tema${n}_mat`).value,
                        desc: $(`tema${n}_desc`).value
                    });
                }
            });
            return data;
        }

        function saveDraft(silent = false) {
            if (!EC0301Manager) {
                if (!silent) toast('Error: M√≥dulo de datos no cargado', 'error');
                return;
            }
            try {
                const data = collectData();
                EC0301Manager.saveData(data); // Guarda todo el objeto de la carta
                if (!silent) toast('Borrador guardado', 'success');
                updateProgress();
            } catch (e) {
                if (!silent) toast(`Error al guardar: ${e.message}`, 'error');
            }
        }

        function loadDraft() {
            if (!EC0301Manager) {
                toast('Error: M√≥dulo de datos no cargado', 'error');
                return;
            }
            try {
                const data = EC0301Manager.getData();
                if (!data || !data.nombre) { 
                    toast('No hay datos guardados. Empezando un nuevo documento.', 'info');
                    addTema(); // A√±ade el primer tema si el documento est√° vac√≠o
                    return;
                }
                
                // Cargar Info General
                $('cd_nombre').value = data.nombre || '';
                $('cd_duracion').value = data.duracion || '';
                $('cd_facilitador').value = data.facilitador || '';
                $('cd_lugar').value = data.lugar || '';
                $('cd_fechas').value = data.fechas || '';
                $('cd_modalidad').value = data.modalidad || 'presencial';
                $('cd_proposito').value = data.proposito || '';
                
                // Cargar Perfil
                $('cd_perfil').value = data.perfil || '';
                $('cd_conoc').value = data.conoc || '';
                $('cd_num').value = data.num || '';
                $('cd_tipo').value = data.tipo || '';
                
                // Cargar Obj General
                if (data.og) {
                    $('og_accion').value = data.og.accion || '';
                    $('og_cond').value = data.og.cond || '';
                    $('og_criterio').value = data.og.criterio || '';
                    updateOG();
                }
                
                // Cargar Obj Particulares
                if (data.objetivos) {
                    $('op1_accion').value = data.objetivos[0]?.accion || '';
                    $('op1_cond').value = data.objetivos[0]?.cond || '';
                    $('op2_accion').value = data.objetivos[1]?.accion || '';
                    $('op2_cond').value = data.objetivos[1]?.cond || '';
                    $('op3_accion').value = data.objetivos[2]?.accion || '';
                    $('op3_cond').value = data.objetivos[2]?.cond || '';
                    $('op4_accion').value = data.objetivos[3]?.accion || '';
                    $('op4_cond').value = data.objetivos[3]?.cond || '';
                }
                
                // Cargar Requerimientos
                if (data.rq) {
                    $('rq_instalaciones').value = data.rq.instalaciones || '';
                    $('rq_equipo').value = data.rq.equipo || '';
                    $('rq_materiales').value = data.rq.materiales || '';
                    $('rq_humanos').value = data.rq.humanos || '';
                    $('rq_seguridad').value = data.rq.seguridad || '';
                }
                
                // Cargar Evaluaci√≥n
                if (data.ev) {
                    $('ev_diag_ins').value = data.ev.diag_ins || 'Cuestionario';
                    $('ev_diag_mom').value = data.ev.diag_mom || 'Al inicio del Encuadre';
                    $('ev_form_ins').value = data.ev.form_ins || 'Gu√≠a de observaci√≥n';
                    $('ev_form_mom').value = data.ev.form_mom || 'Intermedia';
                    $('ev_form_pct').value = data.ev.form_pct || '50';
                    $('ev_sum_ins').value = data.ev.sum_ins || 'Cuestionario';
                    $('ev_sum_mom').value = data.ev.sum_mom || 'Al final del Cierre';
                    $('ev_sum_pct').value = data.ev.sum_pct || '40';
                    $('ev_sat_ins').value = data.ev.sat_ins || 'Cuestionario de satisfacci√≥n';
                    $('ev_sat_mom').value = data.ev.sat_mom || 'Al finalizar el Cierre';
                    $('ev_sat_pct').value = data.ev.sat_pct || '10';
                }
                
                // Cargar Desarrollo
                if (data.dev) {
                    $('dev_comprobacion_t').value = data.dev.comprobacion_t || '15';
                    $('dev_comprobacion_mat').value = data.dev.comprobacion_mat || 'Lista de verificaci√≥n';
                    $('dev_comprobacion_desc').value = data.dev.comprobacion_desc || '';
                    // ... Cargar todos los 5 campos del encuadre y 5 del cierre ...
                }
                
                // Cargar Temas
                if (data.temas && data.temas.length > 0) {
                    $('temasContainer').innerHTML = '';
                    temasCount = 0; 
                    data.temas.forEach(tema => {
                        temasCount++;
                        const container = $('temasContainer');
                        const temaEl = document.createElement('div');
                        temaEl.className = 'box';
                        temaEl.setAttribute('data-tema', temasCount);
                        temaEl.innerHTML = `
                            <h3>
                                <span>Tema/M√≥dulo ${temasCount}</span>
                                <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="removeTema(this, ${temasCount})">
                                    <i class="fas fa-trash"></i> Eliminar
                                </button>
                            </h3>
                            <div class="form-group"><label>Nombre del Tema/M√≥dulo <span class="required">*</span></label><input id="tema${temasCount}_nombre" value="${tema.nombre || ''}" required onkeyup="updateTemasEnObjetivos()"></div>
                            <div class="grid-5"><label>Actividades</label><label>Duraci√≥n (min)</label><label>T√©cnica</label><label>Material/Equipo</label><label>Descripci√≥n</label></div>
                            <div class="grid-5 form-group">
                                <input value="Desarrollo del Tema" disabled>
                                <input type="number" id="tema${temasCount}_duracion" class="time-input" value="${tema.duracion || '60'}" min="0" onchange="recalcTimes()" required>
                                <input id="tema${temasCount}_tec" value="${tema.tec || 'Expositiva / Pr√°ctica'}">
                                <input id="tema${temasCount}_mat" value="${tema.mat || 'Presentaci√≥n, Manual'}">
                                <textarea id="tema${temasCount}_desc">${tema.desc || ''}</textarea>
                            </div>
                        `;
                        container.appendChild(temaEl);
                    });
                }
                
                recalcTimes();
                recalcEval();
                updateProgress();
                toast('Datos cargados correctamente', 'success');
            } catch (error) {
                console.error(error);
                toast('Error al cargar los datos. Se iniciar√° un documento vac√≠o.', 'error');
                if (temasCount === 0) addTema(); // A√±ade el primer tema si todo falla
            }
        }

        // ========== EXPORTACI√ìN ==========
        function exportCarta(formato) { 
            Swal.fire('Funci√≥n en desarrollo', 'La exportaci√≥n a PDF se habilitar√° en futuras versiones.', 'info');
        }

        // ========== AYUDA ==========
        function showHelp() { 
            Swal.fire({
                title: 'Gu√≠a R√°pida EC0301/EC0217.01',
                html: `<div style="text-align: left;">
                         <h4>üìù Carta Descriptiva (Guion Instruccional)</h4>
                         <p>Este formulario te ayuda a crear el documento de planeaci√≥n para un <strong>curso presencial grupal</strong>, alineado a los est√°ndares.</p>
                         <h5 style="margin-top: 1rem;">‚úÖ Elementos clave:</h5>
                         <ul>
                             <li><strong>Objetivos:</strong> El general debe englobar los 4 dominios. Los particulares est√°n fijos (Cognitivo, Psicomotor, Afectivo, Relacional).</li>
                             <li><strong>Requerimientos:</strong> Deben coincidir con los solicitados en el formato oficial.</li>
                             <li><strong>Desarrollo:</strong> Sigue la secuencia de Comprobaci√≥n, Encuadre, Desarrollo (Temas) y Cierre.</li>
                             <li><strong>Tiempos:</strong> El tiempo total calculado debe coincidir con la duraci√≥n que definiste en la Informaci√≥n General.</li>
                         </ul>
                        </div>`,
                width: 600, confirmButtonText: 'Entendido', confirmButtonColor: '#1E3A8A'
            });
        }

        // ========== COMPLETAR ==========
        async function markComplete() {
            if (updateProgress() < 80) { // O un umbral m√°s alto
                await Swal.fire({
                    title: 'Documento incompleto', text: 'Se requiere un 80% de llenado para marcar como completo.',
                    icon: 'warning', confirmButtonText: 'Entendido'
                });
                return;
            }
            
            const result = await Swal.fire({
                title: '¬øMarcar como completado?',
                text: 'Esto guardar√° la carta y desbloquear√° los siguientes m√≥dulos en el dashboard.',
                icon: 'question', showCancelButton: true, confirmButtonText: 'S√≠, completar',
                cancelButtonText: 'Cancelar', confirmButtonColor: '#22C55E'
            });
            
            if (result.isConfirmed) {
                saveDraft(true); // Guardado silencioso
                Swal.fire({
                    title: '¬°Completado!',
                    text: 'La carta descriptiva ha sido guardada. Ser√°s redirigido al dashboard.',
                    icon: 'success', confirmButtonText: 'Excelente', timer: 2000, timerProgressBar: true
                }).then(() => {
                    window.location.href = 'acceso.html'; // Volver al dashboard
                });
            }
        }
    </script>
</body>
</html>
