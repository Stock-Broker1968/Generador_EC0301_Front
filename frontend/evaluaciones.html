<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Instrumentos de Evaluación - EC0301</title>

    <script src="sistema_central/auth.js" defer></script>
    <script src="sistema_central/ec0301-data-manager.js" defer></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof auth !== 'undefined' && !auth.isLoggedIn()) {
                window.location.replace('index.html');
            }
        });
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { 
            --primary: #1E3A8A; --accent: #FF6B35; --success: #22C55E; --warning: #F59E0B;
            --danger: #EF4444; --light: #F8FAFC; --border: #E5E7EB; --text: #1F2937; --muted: #6B7280;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: var(--text);
        }
        /* Estilos generales (header, container, buttons, etc.) */
        .header { background: var(--white); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .header .container { max-width: 1200px; margin: 0 auto; padding: 1.5rem 2rem; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-content h1 { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; color: var(--primary); }
        .toolbar { display: flex; gap: 0.5rem; }
        .btn { padding: 0.6rem 1rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s; }
        .btn-secondary { background-color: var(--light); color: var(--muted); border: 1px solid var(--border); }
        .btn-secondary:hover { background-color: var(--border); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-success:hover { background-color: #1a9c4b; }
        .btn-warning { background-color: var(--warning); color: white; }
        .btn-warning:hover { background-color: #d98a0a; }
        .btn-danger { background-color: var(--danger); color: white; padding: 0.5rem; font-size: 0.8rem; }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; }
        .section { background: var(--white); border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 700; padding: 1.5rem 2rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.75rem; }
        .section-content { padding: 2rem; }
        .info-box { background-color: var(--light); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; }
        .info-box p { font-size: 0.9rem; color: var(--muted); }
        .info-box strong { color: var(--primary); }
        
        /* Estilos para Temario */
        .tema-list { list-style: none; margin-top: 1rem; }
        .tema-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.5rem; }
        .tema-item-name { font-weight: 600; }
        
        /* Estilos para Banco de Preguntas */
        .pregunta-card { border: 1px solid var(--border); border-radius: 8px; margin-bottom: 1.5rem; background: #fdfdff; }
        .pregunta-header { display: flex; justify-content: space-between; align-items: center; background: var(--light); padding: 0.75rem 1rem; border-bottom: 1px solid var(--border); }
        .pregunta-tema { font-size: 0.9rem; font-weight: 600; color: var(--primary); }
        .pregunta-body { padding: 1rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; }
        .form-group textarea, .form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 1rem; }
        .form-group textarea { min-height: 80px; }
        .opcion-group { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; }
        .opcion-group input[type="radio"] { width: auto; }
        .opcion-group input[type="text"] { flex: 1; }
        .opcion-correcta { background: #e0f8e9; border: 1px solid var(--success); }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <h1>
                    <i class="fa-solid fa-tasks" style="color: var(--success);"></i> 
                    Instrumentos de Evaluación
                </h1>
                <div class="toolbar">
                    <a href="acceso.html" class="btn btn-secondary">
                        <i class="fa-solid fa-arrow-left"></i> Volver al Dashboard
                    </a>
                    <button class="btn btn-warning" onclick="saveDraft()">
                        <i class="fa-solid fa-save"></i> Guardar Borrador
                    </button>
                    <button class="btn btn-success" onclick="exportarDocumentos()">
                        <i class="fa-solid fa-file-export"></i> Exportar Todo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-link"></i> 
                Información del Curso (Datos de Carta Descriptiva)
            </h2>
            <div class="section-content">
                <div class="info-box">
                    <p><strong>Curso:</strong> <span id="info_nombre">Cargando...</span></p>
                    <p><strong>Facilitador:</strong> <span id="info_facilitador">Cargando...</span></p>
                    <p id="info_temario_status" style="color: var(--danger);">No se ha encontrado un temario. Por favor, completa y guarda la sección 6 (Desarrollo Cronológico) en tu Carta Descriptiva.</p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-brain"></i> 
                Generador de Reactivos con IA
            </h2>
            <div class="section-content">
                <p style="color: var(--muted); margin-bottom: 1rem;">Haz clic en "Generar" para crear preguntas de opción múltiple para cada tema de tu curso.</p>
                <ul class="tema-list" id="tema-list-container">
                    </ul>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">
                <i class="fa-solid fa-list-check"></i> 
                Banco de Reactivos (Evaluación Sumativa)
            </h2>
            <div class="section-content">
                <p style="color: var(--muted); margin-bottom: 1rem;">Aquí puedes revisar, editar, eliminar o agregar manualmente las preguntas generadas.</p>
                <div id="banco-de-reactivos">
                    </div>
                <button class="btn btn-secondary" onclick="addPreguntaManual()">
                    <i class="fa-solid fa-plus"></i> Agregar Pregunta Manual
                </button>
            </div>
        </div>
    </div>

    <script>
    let EC0301Manager;
    let cartaData;
    let preguntasCount = 0;

    // ========== INICIALIZACIÓN Y CARGA DE DATOS ==========
    document.addEventListener('DOMContentLoaded', () => {
        // (AJUSTE) Verificar que los scripts globales estén cargados
        if (typeof auth === 'undefined' || typeof EC0301Manager === 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Error Crítico',
                text: 'No se pudieron cargar los módulos de sistema (auth.js, ec0301-data-manager.js). Revisa las rutas en el HTML.',
                confirmButtonColor: '#EF4444'
            }).then(() => window.location.href = 'index.html');
            return;
        }

        // Si el login es correcto, cargar el manager y la página
        EC0301Manager = window.EC0301Manager;
        loadCartaData();
    });

    /**
     * Carga los datos de la Carta Descriptiva desde el EC0301Manager
     * y puebla la interfaz.
     */
    function loadCartaData() {
        try {
            cartaData = EC0301Manager.getData();
            if (!cartaData) {
                $('info_temario_status').textContent = 'No se encontraron datos guardados. Completa la Carta Descriptiva.';
                return;
            }

            // 1. Poblar Información General
            $('info_nombre').textContent = cartaData.nombre || 'Nombre de curso no definido';
            $('info_facilitador').textContent = cartaData.facilitador || 'Facilitador no definido';

            // 2. Poblar Temario
            const temaContainer = $('tema-list-container');
            if (cartaData.temas && cartaData.temas.length > 0) {
                $('info_temario_status').textContent = `Se cargaron ${cartaData.temas.length} temas.`;
                $('info_temario_status').style.color = 'var(--success)';
                
                let temaHtml = '';
                cartaData.temas.forEach(tema => {
                    if (tema.nombre) { // Solo mostrar temas con nombre
                        temaHtml += `
                            <li class="tema-item">
                                <span class="tema-item-name">${tema.nombre}</span>
                                <button class="btn btn-success" onclick="generarPreguntasIA('${tema.nombre}')">
                                    <i class="fa-solid fa-brain"></i> Generar Preguntas
                                </button>
                            </li>
                        `;
                    }
                });
                temaContainer.innerHTML = temaHtml;
            }
            
            // Cargar preguntas guardadas
            const preguntasGuardadas = EC0301Manager.loadProduct('evaluacion-sumativa');
            if (preguntasGuardadas && preguntasGuardadas.length > 0) {
                renderPreguntas(preguntasGuardadas);
                toast('Borrador de preguntas cargado', 'success');
            }

        } catch (error) {
            console.error('Error al cargar datos de la carta:', error);
            Swal.fire('Error', 'No se pudieron cargar los datos de la Carta Descriptiva.', 'error');
        }
    }

    // ========== GENERACIÓN DE PREGUNTAS (IA SIMULADA) ==========

    /**
     * Simula una llamada a IA para generar preguntas basadas en un tema.
     * @param {string} temaNombre - El nombre del tema para generar preguntas.
     */
    async function generarPreguntasIA(temaNombre) {
        Swal.fire({
            title: 'Generando preguntas...',
            html: `Usando IA para crear reactivos sobre: <strong>${temaNombre}</strong>`,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // SIMULACIÓN DE LLAMADA A IA
        // En un futuro, aquí iría tu fetch a un endpoint de IA
        await new Promise(resolve => setTimeout(resolve, 1500)); 

        // Datos de ejemplo
        const fakeQuestions = [
            {
                tema: temaNombre,
                pregunta: `¿Cuál es el componente principal de "${temaNombre}"?`,
                opciones: [
                    { texto: 'Opción A (Respuesta Correcta)', correcta: true },
                    { texto: 'Opción B', correcta: false },
                    { texto: 'Opción C', correcta: false },
                ]
            },
            {
                tema: temaNombre,
                pregunta: `¿Cómo se aplica "${temaNombre}" en un contexto práctico?`,
                opciones: [
                    { texto: 'Opción A', correcta: false },
                    { texto: 'Opción B (Respuesta Correcta)', correcta: true },
                    { texto: 'Opción C', correcta: false },
                    { texto: 'Opción D', correcta: false },
                ]
            }
        ];

        Swal.close();
        renderPreguntas(fakeQuestions);
        toast(`¡Se generaron ${fakeQuestions.length} preguntas!`, 'success');
    }

    /**
     * Dibuja las tarjetas de preguntas en el DOM.
     * @param {Array} questions - Array de objetos de pregunta.
     */
    function renderPreguntas(questions) {
        const banco = $('banco-de-reactivos');
        questions.forEach(q => {
            preguntasCount++;
            const preguntaId = `pregunta-${preguntasCount}`;
            let opcionesHtml = '';
            
            q.opciones.forEach((opt, index) => {
                opcionesHtml += `
                    <div class="opcion-group">
                        <input type="radio" name="correcta-${preguntaId}" ${opt.correcta ? 'checked' : ''}>
                        <input type="text" value="${opt.texto}" class="${opt.correcta ? 'opcion-correcta' : ''}">
                    </div>
                `;
            });

            const card = document.createElement('div');
            card.className = 'pregunta-card';
            card.id = preguntaId;
            card.innerHTML = `
                <div class="pregunta-header">
                    <span class="pregunta-tema">Tema: ${q.tema}</span>
                    <button class="btn btn-danger" onclick="removePregunta('${preguntaId}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
                <div class="pregunta-body">
                    <div class="form-group">
                        <label>Pregunta:</label>
                        <textarea>${q.pregunta}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Opciones (marque la correcta):</label>
                        ${opcionesHtml}
                    </div>
                </div>
            `;
            banco.appendChild(card);
        });
    }

    // ========== FUNCIONES DEL BANCO DE REACTIVOS ==========

    function addPreguntaManual() {
        renderPreguntas([{
            tema: 'Manual',
            pregunta: 'Escribe tu pregunta aquí...',
            opciones: [
                { texto: 'Opción A', correcta: true },
                { texto: 'Opción B', correcta: false },
                { texto: 'Opción C', correcta: false },
            ]
        }]);
    }

    function removePregunta(preguntaId) {
        Swal.fire({
            title: '¿Eliminar pregunta?',
            text: 'Esta acción no se puede deshacer.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                $(preguntaId).remove();
                toast('Pregunta eliminada', 'info');
            }
        });
    }
    
    // ========== GUARDAR Y EXPORTAR ==========

    function collectData() {
        const preguntas = [];
        document.querySelectorAll('.pregunta-card').forEach(card => {
            const tema = card.querySelector('.pregunta-tema').textContent.replace('Tema: ', '');
            const pregunta = card.querySelector('textarea').value;
            const opciones = [];
            
            card.querySelectorAll('.opcion-group').forEach(opt => {
                opciones.push({
                    texto: opt.querySelector('input[type="text"]').value,
                    correcta: opt.querySelector('input[type="radio"]').checked
                });
            });

            preguntas.push({ tema, pregunta, opciones });
        });
        return preguntas;
    }

    function saveDraft() {
        try {
            const data = collectData();
            EC0301Manager.saveProduct('evaluacion-sumativa', data);
            toast('Borrador de evaluaciones guardado', 'success');
        } catch (e) {
            toast(`Error al guardar: ${e.message}`, 'error');
        }
    }

    function exportarDocumentos() {
        Swal.fire('Función en desarrollo', 'La exportación a PDF y Word para las evaluaciones estará disponible próximamente.', 'info');
        // Aquí iría la lógica de exportación a PDF/Word
    }

    // ========== UTILIDADES ==========
    const $ = id => document.getElementById(id);
    function toast(mensaje, tipo = 'success') {
        Swal.fire({
            toast: true, position: 'top-end', icon: tipo,
            title: mensaje, showConfirmButton: false, timer: 3000, timerProgressBar: true
        });
    }
    </script>
</body>
</html>
